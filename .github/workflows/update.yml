name: Proxy Converter and Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Запуск раз в сутки в полночь

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd

      - name: Download, Convert and Check
        run: |
          # 1. Создаем рабочие файлы
          touch raw_combined.txt
          touch cleaned.txt
          touch live_proxies.txt

          # 2. Собираем прокси из всех источников (включая твой новый)
          urls=(
            "https://raw.githubusercontent.com/ClearProxy/checked-proxy-list/refs/heads/main/socks5/raw/all.txt"
            "https://raw.githubusercontent.com/TheSpeedX/SOCKS-List/master/socks5.txt"
            "https://raw.githubusercontent.com/MuRongPIG/Proxy-Master/main/socks5.txt"
          )

          for url in "${urls[@]}"; do
            curl -L "$url" >> raw_combined.txt
          done

          # 3. Чистим: удаляем префиксы, убираем дубликаты и берем первые 500
          sed -E 's/^(socks5:\/\/|socks4:\/\/|http:\/\/|https:\/\/)//I' raw_combined.txt | tr -d '\r' | sort -u | grep -E '^[0-9.]+: [0-9]+$' | head -n 500 > cleaned.txt

          # 4. Быстрая проверка в 50 потоков (xargs)
          echo "Checking proxies..."
          cat cleaned.txt | xargs -P 50 -I {} sh -c '
            line="{}"
            IP=$(echo "$line" | cut -d: -f1)
            PORT=$(echo "$line" | cut -d: -f2)
            if nc -z -w 3 "$IP" "$PORT" > /dev/null 2>&1; then
              echo "socks5://$line" >> live_proxies.txt
            fi
          '

          # 5. Сохраняем результат
          if [ -s live_proxies.txt ]; then
            sort -u live_proxies.txt > list.txt
            echo "Success: Found $(wc -l < list.txt) live proxies."
          else
            echo "No live proxies found. Keeping old file."
            exit 0
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add list.txt
          git commit -m "Daily proxy update: $(date)" || exit 0
          git push
