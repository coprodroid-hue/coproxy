name: Proxy Converter and Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl

      - name: Download, Convert and Check
        run: |
          # 1. Сбор данных
          urls=(
            "https://raw.githubusercontent.com/ClearProxy/checked-proxy-list/refs/heads/main/socks5/raw/all.txt"
            "https://raw.githubusercontent.com/elliottophellia/proxylist/refs/heads/master/results/socks5/global/socks5_checked.txt"
          )
          for url in "${urls[@]}"; do curl -L -s "$url" >> raw_combined.txt || true; done

          # 2. Очистка (удаляем протоколы и берем первые 1000)
          sed -E 's/^(socks5:\/\/|socks4:\/\/|http:\/\/|https:\/\/)//I' raw_combined.txt | tr -d '\r' | sort -u | grep -E '^[0-9.]+:[0-9]+$' | head -n 1000 > cleaned.txt

          # 3. Проверка (100 потоков, тайм-аут 10 секунд)
          touch live_proxies.txt
          cat cleaned.txt | xargs -P 100 -I {} sh -c '
            proxy="{}"
            # Проверка порта + глубокий тест через Cloudflare
            if nc -z -w 5 $(echo "$proxy" | tr ":" " ") > /dev/null 2>&1; then
              if curl --socks5-hostname "$proxy" -sI --connect-timeout 10 --max-time 15 https://1.1.1.1 > /dev/null 2>&1; then
                echo "socks5://$proxy" >> live_proxies.txt
              fi
            fi
          ' || true

          # 4. Формирование финального файла
          if [ -s live_proxies.txt ]; then
            sort -u live_proxies.txt > list.txt
          else
            echo "socks5://1.1.1.1:1111" > list.txt
          fi

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add list.txt
          git commit -m "Update list: $(date +'%Y-%m-%d %H:%M') [Found: $(wc -l < list.txt)]" || exit 0
          git push
