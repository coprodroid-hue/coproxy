name: Mega-Proxy-Checker

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Proxies
        run: |
          # Подготовка файлов
          touch socks5.txt socks4.txt http.txt
          
          # --- СБОР SOCKS5 ---
          urls_s5=(
            "https://raw.githubusercontent.com/ClearProxy/checked-proxy-list/refs/heads/main/socks5/raw/all.txt"
            "https://raw.githubusercontent.com/elliottophellia/proxylist/refs/heads/master/results/socks5/global/socks5_checked.txt"
            "https://raw.githubusercontent.com/TheSpeedX/SOCKS-List/master/socks5.txt"
            "https://raw.githubusercontent.com/MuRongPIG/Proxy-Master/main/socks5.txt"
            "https://api.proxyscrape.com/v2/?request=displayproxies&protocol=socks5"
            "https://raw.githubusercontent.com/officialputuid/Proxy-List/master/socks5.txt"
          )
          for url in "${urls_s5[@]}"; do curl -L -s "$url" >> s5_raw.txt || true; done
          sed -E 's/^(socks5:\/\/|socks4:\/\/|http:\/\/|https:\/\/)//I' s5_raw.txt | tr -d '\r' | sort -u | grep -E '^[0-9.]+:[0-9]+$' | head -n 3000 > s5_clean.txt
          
          echo "Checking SOCKS5..."
          cat s5_clean.txt | xargs -P 100 -I {} sh -c '
            proxy="{}"
            if curl --socks5-hostname "$proxy" -sI --connect-timeout 8 --max-time 15 https://www.google.com > /dev/null 2>&1; then
              echo "socks5://$proxy" >> socks5.txt
            fi
          ' || true

          # --- СБОР SOCKS4 ---
          urls_s4=(
            "https://raw.githubusercontent.com/ClearProxy/checked-proxy-list/refs/heads/main/socks4/raw/all.txt"
            "https://raw.githubusercontent.com/TheSpeedX/SOCKS-List/master/socks4.txt"
          )
          for url in "${urls_s4[@]}"; do curl -L -s "$url" >> s4_raw.txt || true; done
          sed -E 's/^(socks5:\/\/|socks4:\/\/|http:\/\/|https:\/\/)//I' s4_raw.txt | tr -d '\r' | sort -u | grep -E '^[0-9.]+:[0-9]+$' | head -n 1000
